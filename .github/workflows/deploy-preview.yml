name: Build and Deploy Preview

on:
    pull_request:
        types: [opened, synchronize, reopened, ready_for_review]
        paths:
            - "src/**"
            - "content/**"
            - "package.json"
            - "pnpm-lock.yaml"
            - "svelte.config.js"
            - "wrangler.jsonc"

concurrency:
    group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
    cancel-in-progress: true

permissions:
    contents: read
    deployments: write
    pull-requests: write

jobs:
    build-and-deploy-preview:
        runs-on: macos-latest
        environment:
            name: preview-pr-${{ github.event.pull_request.number }}
            url: ${{ env.PREVIEW_BASE }}
        env:
            PREVIEW_ALIAS: pr-${{ github.event.pull_request.number }}
            PREVIEW_BASE: https://pr-${{ github.event.pull_request.number }}-arcane-website.ofkm.workers.dev
        steps:
            - name: Checkout
              uses: actions/checkout@v5
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Setup Node
              uses: actions/setup-node@v5
              with:
                  node-version: 24

            - name: Install dependencies
              run: pnpm install

            - name: Check Wrangler version
              run: pnpm exec wrangler --version

            - name: Build site
              run: pnpm build

            - name: Upload and Deploy Preview
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
              run: |
                  pnpm exec wrangler versions upload --preview-alias "$PREVIEW_ALIAS"

            - name: Find Comment
              uses: peter-evans/find-comment@v3
              id: fc
              with:
                  issue-number: ${{ github.event.pull_request.number }}
                  comment-author: "github-actions[bot]"
                  body-includes: Preview deployed successfully!

            - name: Comment preview URL
              uses: peter-evans/create-or-update-comment@v4
              with:
                  comment-id: ${{ steps.fc.outputs.comment-id }}
                  issue-number: ${{ github.event.pull_request.number }}
                  token: ${{ secrets.GITHUB_TOKEN }}
                  body: |
                      ðŸš€ Preview deployed successfully!

                      **Preview URL**: ${{ env.PREVIEW_BASE }}

                      Built from commit ${{ github.sha }}

                      ---
                      <sub>Powered by Cloudflare Workers</sub>
                  edit-mode: replace
